{# Relationships for this record #}
    {% for relcontenttype, relation in context.contenttype.relations %}
    {% if relation.group == group_name or relation.group is not defined and group_name == "relations" %}
        <div class="form-group">

        {# Prefix #}
        {% if relation.prefix is defined and relation.prefix is not empty %}
            <div class="prefix">
                {{ relation.prefix|markdown }}
            </div>
        {% endif %}

        {# Relationship #}
        <fieldset>
            {# We set the 'format' for the rendering of each <option>. With fallback to a sensible default. #}
            {% set format = relation.format|default("{{ item.title|escape }} <span>(â„– {{ item.id }})</span>") %}

            {{ macro.label(relation.label, relcontenttype|ucfirst, 'col-sm-4 control-label', 'relation-' ~ relcontenttype) }}
            <div class="col-sm-8{% if relation.sortable|default(false) %} sortable-select2-container{% endif %}">
                
                {% if relation.multiple is defined and relation.multiple == 1 %}
                    <select name="relation[{{ relcontenttype }}][]" id="relation-{{ relcontenttype }}" class="wide" multiple style="width: 100%;" data-placeholder="{{ __('(none)') }}">
                {% else %}
                    <select name="relation[{{ relcontenttype }}][]" id="relation-{{ relcontenttype }}" class="wide" style="width: 100%;" data-placeholder="{{ __('(none)') }}">
                        <option value="0">{{ __('(none)') }}</option>
                {% endif %}
                    {% if relation.sortable|default(false) %}
                        {% set sortedRelations = getSortedRelations(context.content, context.content.contenttype.slug) %}
                        {% set iterationset =  relationSort(sortedRelations, listcontent(relcontenttype, relation, context.content)) %}
                    {% else %}
                        {% set iterationset = listcontent(relcontenttype, relation, context.content) %}
                    {% endif %}

                    {% set groupby = relation.groupby|default(false) %}
                    {% set optgroup = '' %}
                    {% for item in iterationset %}
                        {% if relcontenttype == app.request.get('relation') and item.id == app.request.get('relationid') %}
                            {% set selectedbyrelation = true %}
                        {% else %}
                            {% set selectedbyrelation = false %}
                        {% endif %}
                        {% if groupby and optgroup != item[groupby] %}
                            {% if optgroup != '' %}</optgroup>{% endif %}
                            {% set optgroup = item[groupby] %}
                            <optgroup label="{{ optgroup }}">
                        {% endif %}
                        <option value="{{ item.id }}"{% if item.selected or selectedbyrelation %} selected{% endif %}>
                            {{ format|twig({'item': item}) }}
                        </option>
                    {% endfor %}
                    {% if optgroup != '' %}</optgroup>{% endif %}

                </select>

                <script>
                    {% if relation.sortable %}
                        $(function() {
                            $('#relation-{{ relcontenttype }}').select2Sortable({});
                        });
                    {% else %}
                        $(function() {
                            $('#relation-{{ relcontenttype }}').select2({
                                placeholder: "{{ __('(none)') }}",
                                allowClear: true
                                {% if groupby %}, formatSelection: function (item) {
                                    return $(item.element).parent().attr('label') + ': ' + item.text;
                                }{% endif %}
                            });
                        });
                    {% endif %}
                </script>

            </div>
        </fieldset>

        {# Postfix #}
        {% if relation.postfix is defined and relation.postfix is not empty %}
            <div class="postfix">
                {{ relation.postfix|markdown }}
            </div>
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}


